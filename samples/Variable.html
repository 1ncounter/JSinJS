<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>javascript grammar tree preprocessr</title>
<style>
.symbolName {
    display:block;
}
.childContainer {
    padding-left:30px;
}
</style>
<script src="../source/LexicalParser.js"></script>
<script src="../source/SyntacticalParser.js"></script>
<script src="../source/Parser.js"></script>
<script>

var preprocessors = {
    "VariableDeclarationNoIn":preprocessVariable,
    "VariableDeclaration":preprocessVariable,
    "FunctionDeclaration":preprocessFunctionDeclaration,
    "FunctionExpression":preprocessFunctionExpression
}
var processors = {
    "Catch":processCatch,
    "FunctionDeclaration":processFunctionDeclaration,
    "FunctionExpression":processFunctionExpression,
    "FunctionBody":processCode,
    "IdentifierName":processIdentifierName,
    "Program":processCode,
    "FormalParameterList":processParameter,
    "Identifier":processIdentifier
}

function preprocessVariable(scope,node) {
    var i = node.childNodes.length;
    scope.addIdentifier(node.childNodes[node.childNodes.length-1].token.toString());
    while(i--) {
        preprocess(scope,node.childNodes[i]);
    }
}

function preprocessFunctionDeclaration(scope,node) {    
    var i = node.childNodes.length;
    while(i--){
        if(node.childNodes[i].name == "Identifier") {
            scope.addIdentifier(node.childNodes[i].token.toString());
        }
    }
}
function preprocessFunctionExpression(scope,node) {    

}
function preprocessCode(scope,node) {
    var i = node.childNodes.length;
    while(i--)preprocess(scope,node.childNodes[i]);
}

function preprocess(scope,node) {
    if(preprocessors[node.name]) return preprocessors[node.name](scope,node);

    var i = node.childNodes.length;
    while(i--)preprocess(scope,node.childNodes[i]);
}

function processParameter(scope,node) {
    if(!node)
        debugger;
    var i = node.childNodes.length;
    while(i--) {
        if(node.childNodes[i].token)
            scope.addIdentifier(node.childNodes[i].token.toString());
        else
            processParameter(scope,node.childNodes[i]);
    }
}
function processFunctionExpression(scope,node) {
    scope = new Scope(scope);
    var i = node.childNodes.length;
    while(i--){
        if(node.childNodes[i].name == "Identifier") {
            scope.addIdentifier(node.childNodes[i].token.toString());
        }
    }
    scope = new Scope(scope);
    scope["arguments"] = undefined;
    
    var i = node.childNodes.length;
    while(i--){
        if(node.childNodes[i].name == "FormalParameterList") {
            process(scope,node.childNodes[i]);
        }        
    }
    var i = node.childNodes.length;
    while(i--){
        if(node.childNodes[i].name == "FunctionBody") {
            process(scope,node.childNodes[i]);
        }        
    }
}
function processFunctionDeclaration(scope,node) {
    scope = new Scope(scope);
    scope["arguments"] = undefined;
 
    var i = node.childNodes.length;
    while(i--){
        if(node.childNodes[i].name == "FormalParameterList") {
            process(scope,node.childNodes[i]);
        }        
    }
    var i = node.childNodes.length;
    while(i--){
        if(node.childNodes[i].name == "FunctionBody") {
            process(scope,node.childNodes[i]);
        }
    }
}
function processIdentifier(scope,node) {
    scope.accessIdentifier(node.token.toString());
}
function processIdentifierName(scope,node) {
    return;
}
function processCode(scope,node) {
    preprocess(scope,node);
    var i = node.childNodes.length;
    while(i--)process(scope,node.childNodes[i]);
}
function processCatch(scope,node) {
    scope = new Scope(scope);
    var i = node.childNodes.length;
    while(i--){
        if(node.childNodes[i].name == "Identifier") {
            scope.addIdentifier(node.childNodes[i].token.toString());
        }
    }
    var i = node.childNodes.length;
    while(i--){
        if(node.childNodes[i].name == "FunctionBody") {
            process(scope,node.childNodes[i]);
        }        
    }
    
}
function process(scope,node) {
    if(processors[node.name]) return processors[node.name](scope,node);
    var i = node.childNodes.length;
    while(i--)process(scope,node.childNodes[i]);
} 

function Scope(parent){

    this.parent = parent || null;

    var table = Object.create(null);
    var used = Object.create(null);
    this.accessIdentifier = function(id){


        if(!this.parent) {
            if(!Object.prototype.hasOwnProperty.call(table,id))
                used[id] = undefined;
        }
        else if(!Object.prototype.hasOwnProperty.call(table,id)) {
            this.parent.accessIdentifier(id);
        }
    }
    this.addIdentifier = function(id){
        table[id] = undefined;
    }

    this.getUsed = function (){
        return Object.keys(used);
    }
    this.getDeclared = function(){
        return Object.keys(table);
    }
}

window.onload = function(){
    
    document.querySelector("button").onclick = function(){
        //try {
            var parser = new Parser();
            preprocessr.innerHTML = "";
            var tree = parser.parse(document.querySelector("#code").value);
            var o = new Scope();
            process(o,tree);
            document.getElementById("declared").innerHTML = o.getDeclared().join(" ");
            document.getElementById("used").innerHTML = o.getUsed().join(" ");

        //} catch(e) {
        //    preprocessr.innerHTML = "<span style=\"color:red;\">"+e+"</span>"
        //}
    }
}
</script>
</head>
<body>
声明的变量：
<div id="declared"></div>
使用的变量：
<div id="used"></div>
<textarea id="code" style="width:100%;height:500px;"></textarea>
<button >parse</button>
    <div id="preprocessr">

    </div>
    
</body>
</html>